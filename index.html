<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Configuration validation: Drupal's next leap?'</title>

    <meta name="description" content="TBD">
    <meta name="author" content="Wim Leers">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="reveal.js/dist/reset.css">
    <link rel="stylesheet" href="reveal.js/dist/reveal.css">
    <link rel="stylesheet" href="reveal.js/dist/theme/black.css" id="theme">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="reveal.js/plugin/highlight/monokai.css">
    <style>
      @keyframes loading {
        0 {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      @keyframes growingshrinking {
        from {
            transform: scale(1);
        }
        to {
            transform: scale(3);
        }
      }
      .bad {
        color: #ff2c2d;
      }
      .fragment.blur {
        filter: blur(5px);
      }
      .fragment.blur.visible {
        filter: none;
      }
      ul.blockers {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      ul.blockers li {
        padding-left: 1rem;
        text-indent: -0.75rem;
      }
      ul.blockers li::before {
        content: '🛑 ';
      }
      </style>
  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section id="intro" data-background="img/19bbg4cwuf7tyjpg.jpg" data-background-via="http://i.kinja-img.com/gawker-media/image/upload/s--w3wd0uOT--/19bbg4cwuf7tyjpg.jpg">
          <h1>Config validation</h1>
          <h2><em>Drupal's next leap?</em></h2>
          <hr>
          <div>
            <p>Wim Leers
              <br><small style="vertical-align: baseline">Senior Principal Software Engineer
                <br><img src="img/acquia.png" alt="Acquia logo" style="border:none;height:1em;background:none;margin:0;">'s Drupal Acceleration Team</small>
            </p>
          </div>
        </section>

        <section>
          <section id="history" style="font-size:90%">
            <table>
              <caption>A brief history of config in Drupal</caption>
              <tr class="fragment"><th>era</th><th>storage</th><th><em>blobbiness</em></th><th></th></tr>
              <tr class="fragment"><td>2004</td><td><code>variable</code> table</td><td>extremely</td><td>🙈</td></tr>
              <tr class="fragment"><td><a href="https://www.drupal.org/node/1500260">2012</a></td><td>YAML files</td><td>diffable</td><td>🤓𝍔</td></tr>
              <tr class="fragment"><td><a href="https://www.drupal.org/node/1905120">2013</a></td><td>[…] + schema</td><td>introspectable</td><td>🤔💡</td></tr>
              <tr class="fragment"><td><a href="https://www.drupal.org/node/2241059">2014</a></td><td><code>config</code> table + […]</td><td><em>unchanged</em></td><td>🏎️</td></tr>
              <tr class="fragment"><td><a href="https://www.drupal.org/node/2870878">2017</a></td><td>[…] + […] + constraints</td><td>validatable</td><td>✅</td></tr>
            </table>
          </section>
          <section id="history--trend">
            <p>Trend: more structure</p>
            <ul>
              <li class="fragment custom blur">introspectable&nbsp;&nbsp;(👋 <a href="https://www.drupal.org/project/variable"><code>variable</code></a> module)
              <li class="fragment custom blur">translatable&nbsp;(👋 <a href="https://www.drupal.org/project/i18n"><code>i18n</code></a> module)
              <li class="fragment custom blur">exportable&nbsp;&nbsp;&nbsp;&nbsp;(👋 <a href="https://www.drupal.org/project/i18n"><code>ctools</code></a> exportables)
            </ul>
          </section>
          <section id="history--caveat">
            <p><code>type: uuid</code></p>
            <div class="fragment">
              <p>👆</p>
              <p>the only validatable config type</p>
            </div>
            <p class="fragment">😱</p>
          </section>
        </section>

      <section>
        <section id="why" data-background-gradient="radial-gradient(grey, black)" style="text-shadow: -1px 1px 2px #23430C">
          <h2>Why?</h2>
          <p>🤷‍♀️</p>
        </section>
        <section id="why-blockers">
          <ul class="blockers">
            <li class="fragment custom blur">Writing configuration via JSON:API
            <li class="fragment custom blur">Admin UI improvements <span style="padding-left: 1em; font-size: 70%" class="fragment">🪦 JS Admin UI</span>
            <li class="fragment custom blur">Reliable <span style="font-size: 90%"><code>config_split</code><span class="fragment">, <code>config_filter</code> …</span></span>
            <li class="fragment custom blur">Recipes Initiative
            <li class="fragment custom blur">Automatic Updates Initiative
            <li class="fragment custom blur">Ambitious site builder experiences
          </ul>
          <aside class="notes">
            There are many capabilities blocked on this.

            It's not just that this blocks writing configuration via JSON:API, which in turn blocked the JS Admin UI initiative which has since stopped. It's also that it is impossible to reuse the same validation logic for the JS admin UI: it literally needs to be re-implemented, which is a big security risk. If we move the current logic out of forms, we benefit multiple times: custom admin UIs (on the server or client) become possible, UIs become simpler to maintain, additional validation (from a contrib or custom module) becomes easy to add, et cetera.

            Talking to Fabian Bircher, maintainer of https://www.drupal.org/project/config_split and https://www.drupal.org/project/config_filter, he said a key problem is to know if a key is required or not. Sometimes when a value is null or the array empty we can omit the key and sometimes not. These are problems that are easily solvable with validation.
          </aside>
        </section>
      </section>

        <section>
          <section id="config-schema-constraints">
            <h3>Config schema 101</h3>
            <p>📚</p>
          </section>
          <section id="config-schema-constraints--type-use">
            <p><code>type: uuid</code> use</p>
            <figure>
              <pre><code class="language-yaml" data-trim data-line-numbers="5" style="font-size: 120%">config_entity:
  type: mapping
  mapping:
    uuid:
      type: uuid
      label: 'UUID'
  …
</code></pre>
            </figure>
          </section>
          <section id="config-schema-constraints--type-definition">
            <p><code>type: uuid</code> definition</p>
            <figure>
              <pre><code class="language-yaml" data-trim data-line-numbers="|2|3|4|5-6" style="font-size: 120%"># A UUID.
uuid:
  type: string
  label: 'UUID'
  constraints:
    Uuid: {}
</code></pre>
              <figcaption style="font-size: 50%"><code>core/config/schema/core.data_types.schema.yml</code></figcaption>
            </figure>
          </section>
          <section id="config-schema-constraints--plugin">
            <figure>
              <figcaption style="font-size: 70%;">
                "<code>Uuid</code>" 👉 a <code>@Constraint</code> plugin ID
              </figcaption>
              <pre><code data-line-numbers="|9-12|14|1-4|19-21|23" class="language-php" style="line-height: 110%; font-size: 90%">namespace Drupal\Core\Validation\Plugin\Validation\Constraint;

use Symfony\Component\Validator\Constraints\Uuid;
use Symfony\Component\Validator\Constraints\UuidValidator;

/**
 * Validates a UUID.
 *
 * @Constraint(
 *   id = "Uuid",
 *   label = @Translation("Universally Unique Identifier", context = "Validation"),
 * )
 */
class UuidConstraint extends Uuid {

  /**
   * {@inheritdoc}
   */
  public function validatedBy() {
    return UuidValidator::class;
  }

  public $message = 'This is not a valid UUID.';

}
</code></pre>
            </figure>
          </section>
          <section id="config-schema-constraints--plugin-validator">
            <figure>
              <pre><code data-line-numbers="|3|5|6-8|9-11|12" class="language-php" style="line-height: 110%; font-size: 90%">namespace Symfony\Component\Validator\Constraints;

class UuidValidator extends ConstraintValidator {

    public function validate(mixed $value, Constraint $constraint) {
        if (!$constraint instanceof Uuid) {
            throw new UnexpectedTypeException($constraint, Uuid::class);
        }
        if (!\is_scalar($value) && !$value instanceof \Stringable) {
            throw new UnexpectedValueException($value, 'string');
        }
        …
    }

}
</code></pre>
            </figure>
          </section>
          <section data-background-gradient="radial-gradient(#283b95, #17b2c3)">
            <h2>🧑‍🎓🥳</h2>
          </section>
          <section id="config-schema-constraints--before">
            <h4>Before <code>type: uuid</code></h4>
            <figure class="fragment">
              <pre><code class="language-diff" style="width: max-content; margin: 0 auto; font-size: 120%">     uuid:
-      type: string
-      label: 'UUID'
+      type: uuid
</code></pre>
              <figcaption><em>Any</em> string 😳
            </figure>
          </section>
          <section data-background-gradient="radial-gradient(#283b95, #17b2c3)">
            <h2>🤔</h2>
          </section>
          <section data-background-gradient="radial-gradient(orange, red)">
            <h2>🤯</h2>
          </section>
        </section>
      </section>

      <section>
        <section id="config_inspector">
          <h2>Live demo #1</h2>
          <a href="https://www.drupal.org/project/config_inspector">d.o/project/config_inspector</a>
        </section>
        <section data-background="img/config_inspector_drush.png" data-background-size=contain></section>
        <section data-background="img/config_inspector_drush2.png" data-background-size=contain></section>
        <section>
          <pre><code class="hljs sh">drush config:inspect</code></pre>
          <pre><code class="hljs sh">drush config:inspect --todo</code></pre>
          <pre><code class="hljs sh">drush config:inspect --filter-keys=node.type.article \
                     --detail \
                     --list-constraints</code></pre>
        </section>
      </section>
      <section>
        <section id="form">
          <h2>Live demo #2</h2>
          <p>Validation constraints in forms</p>
        </section>
        <section data-auto-animate>
          <ol>
            <li class="fragment custom blur">Implement <code>ConfigFormBase</code>'s optional methods <small>since Drupal 10.2: <a href="https://www.drupal.org/node/3373502">#3373502</a></small>
            <li class="fragment custom blur">💰🌈</li>
          </li>
          </ol>
        </section>
        <section data-auto-animate>
          <ol>
            <li class="fragment custom blur">Implement <code>ConfigFormBase</code>'s optional methods <small>since Drupal 10.2: <a href="https://www.drupal.org/node/3373502">#3373502</a></small>
            <li class="fragment custom blur">💰🌈</li>
            <li class="fragment custom blur">Optional: <code>ConfigEvents::SAVE</code> subscriber <small>to validate <em>your</em> config</small>
            <li class="fragment custom blur">🥳🥇
          </li>
          </ol>
        </section>
      </section>
      <section>
        <section id="thanks">
          <h2>🙏</h2>
          <ul>
            <li>Joris Vercammen aka <a href="https://www.drupal.org/u/borisson_">@borisson_</a> — Calibrate</li>
            <li>Adam Hoenich aka <a href="https://www.drupal.org/u/phenaproxima">@phenaproxima</a> — Acquia</li>
            <li>Ben Mullins aka <a href="https://www.drupal.org/u/bnjmnm">@bnjmnm</a> — Acquia</li>
            <li>Fabian Bircher aka <a href="https://www.drupal.org/u/bircher">@bircher</a> — Nuvole</li>
            <li>Daniel Wehner aka <a href="https://www.drupal.org/u/dawehner">@dawehner</a> <sup>(2018!)</sup></li>
            <li>Alex Pott aka <a href="https://www.drupal.org/u/alexpott">@alexpott</a> <sup>(2018–now!)</sup></li>
          </ul>
        </section>
        <section id="current-status">
          <h2>🙇🏻‍♂️</h2>
          <table class="fragment custom blur">
            <tr><td>META</td><td><a href="https://www.drupal.org/project/drupal/issues/2164373">#2164373</a><div class="fragment" style="position: absolute; right: -.5em; top: 2.7em">👀&nbsp;&nbsp;<span style="position: relative; top: .5em">⤵</span><br><img src="img/meta-issue-url.gif"></div></td></tr>
            <tr><td>🟢 Required values</td><td><a href="https://www.drupal.org/project/drupal/issues/3364109">#3364109</a></td></tr>
            <tr><td>🟡 Required keys</td><td><a href="https://www.drupal.org/project/drupal/issues/3364108">#3364108</a></td></tr>
            <tr><td>🚢 <del>Validate in tests</del></td><td><a href="https://www.drupal.org/project/drupal/issues/3361534">#3361534</a></td></tr>
            <tr><td>Metadata for rich UX</td><td><a href="https://www.drupal.org/project/drupal/issues/2949888">#2949888</a></td></tr>
          </table>
          <blockquote class="fragment custom blur grow">Which config changes have caused outages for YOU? <span style="animation: growingshrinking 2.5s linear infinite; animation-direction: alternate-reverse">🫵</blockquote>
          <aside class="notes">
            Thanks, that's all!

            If you're interested, these issues are currently the most important ones. If you're going to follow one issue, follow the top one. Here's a QR code for it!

            In general, look for the "Configuration schema" and "validation" tags.
        </section>
      </section>

      </div>

    </div>

    <script src="reveal.js/dist/reveal.js"></script>
    <script src="reveal.js/plugin/zoom/zoom.js"></script>
    <script src="reveal.js/plugin/notes/notes.js"></script>
    <script src="reveal.js/plugin/search/search.js"></script>
    <script src="reveal.js/plugin/markdown/markdown.js"></script>
    <script src="reveal.js/plugin/highlight/highlight.js"></script>
    <script>

      // Also available as an ES module, see:
      // https://revealjs.com/initialization/
      Reveal.initialize({
        controls: true,
        progress: true,
        center: true,
        hash: true,

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [ RevealZoom, RevealNotes, RevealSearch, RevealMarkdown, RevealHighlight ]
      });

    </script>

  </body>
</html>