<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Configuration validation: Drupal's next leap?'</title>

    <meta name="description" content="TBD">
    <meta name="author" content="Wim Leers">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="reveal.js/dist/reset.css">
    <link rel="stylesheet" href="reveal.js/dist/reveal.css">
    <link rel="stylesheet" href="reveal.js/dist/theme/black.css" id="theme">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="reveal.js/plugin/highlight/monokai.css">
    <style>
      @keyframes loading {
        0 {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      @keyframes growingshrinking {
        from {
            transform: scale(1);
        }
        to {
            transform: scale(3);
        }
      }
      .bad {
        color: #ff2c2d;
      }
      .fragment.blur {
        filter: blur(5px);
      }
      .fragment.blur.visible {
        filter: none;
      }
      </style>
  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section id="intro" data-background="img/19bbg4cwuf7tyjpg.jpg" data-background-via="http://i.kinja-img.com/gawker-media/image/upload/s--w3wd0uOT--/19bbg4cwuf7tyjpg.jpg">
          <h2>Config validation</h2>
          <h3><em>Drupal's next leap?</em></h3>
          <hr>
          <div>
            <p style="font-size: 70%">Wim Leers
              <br><small style="vertical-align: baseline">Senior Principal Software Engineer
                <br><img src="img/acquia.png" alt="Acquia logo" style="border:none;height:1em;background:none;margin:0;">'s Drupal Acceleration Team</small>
            </p>
          </div>
        </section>
        <section>
          <section id="history" style="font-size:90%">
            <table>
              <caption>A brief history of config in Drupal</caption>
              <tr class="fragment"><th>era</th><th>storage</th><th><em>blobbiness</em></th><th></th></tr>
              <tr class="fragment"><td>2004</td><td><code>variable</code> table</td><td>extremely</td><td>🙈</td></tr>
              <tr class="fragment"><td><a href="https://www.drupal.org/node/1500260">2012</a></td><td>YAML files</td><td>diffable</td><td>🤓𝍔</td></tr>
              <tr class="fragment"><td><a href="https://www.drupal.org/node/1905120">2013</a></td><td>[…] + schema</td><td>introspectable</td><td>🤔💡</td></tr>
              <tr class="fragment"><td><a href="https://www.drupal.org/node/2241059">2014</a></td><td><code>config</code> table + […]</td><td><em>unchanged</em></td><td>🏎️</td></tr>
              <tr class="fragment"><td><a href="https://www.drupal.org/node/2870878">2017</a></td><td>[…] + […] + constraints</td><td><em>validatable</em></td><td>✅</td></tr>
            </table>
          </section>
          <section id="history--trend">
            <p>More structure ⇒ versionable (no more <a href="https://www.drupal.org/project/variable"><code>variable</code></a> module), translatable (no more <a href="https://www.drupal.org/project/i18n"><code>i18n</code></a> module) …</p>
          </section>
          <section id="history--caveat">
            <p><code>type: uuid</code></p>
            <div class="fragment">
              <p>👆</p>
              <p>the only validatable config</p>
            </div>
            <p class="fragment">😱</p>
          </section>
        </section>
        <section>
          <section id="config-schema-constraints">
            <h4><code>type: uuid</code></h4>
            <figure>
              <pre><code class="language-yaml" style="width: max-content; margin: 0 auto; font-size: 120%"># A UUID.
uuid:
  type: string
  label: 'UUID'
  constraints:
    Uuid: {}
</code></pre>
              <figcaption style="font-size: 50%"><code>core/config/schema/core.data_types.schema.yml</code></figcaption>
            </figure>
          </section>
          <section id="config-schema-constraints--plugin">
            <figure>
              <figcaption style="font-size: 70%;">
                "<code>Uuid</code>" 👈 a <code>@Constraint</code> plugin ID
              </figcaption>
              <pre><code class="language-php" style="line-height: 110%; font-size: 90%">/**
 * Validates a UUID.
 *
 * @Constraint(
 *   id = "Uuid",
 *   label = @Translation("Universally Unique Identifier", context = "Validation"),
 * )
 */
class UuidConstraint extends Uuid {

  /**
   * {@inheritdoc}
   */
  public function validatedBy() {
    return UuidValidator::class;
  }

}
</code></pre>
            </figure>
          </section>
          <section id="config-schema-constraints--plugin-validator">
            <figure>
              <figcaption style="font-size: 70%;">
                <code>validatedBy()</code> 👈 a <code>ConstraintValidatorInterface</code> class
              </figcaption>
              <pre><code class="language-php" style="line-height: 110%; font-size: 90%">namespace Symfony\Component\Validator\Constraints;

class UuidValidator extends ConstraintValidator {

    public function validate(mixed $value, Constraint $constraint) {
        if (!$constraint instanceof Uuid) {
            throw new UnexpectedTypeException($constraint, Uuid::class);
        }
        if (!\is_scalar($value) && !$value instanceof \Stringable) {
            throw new UnexpectedValueException($value, 'string');
        }
        …
    }

}
</code></pre>
            </figure>
          </section>
          <section id="config-schema-constraints--before">
            <h4>Before <code>type: uuid</code></h4>
            <figure class="fragment">
              <pre><code class="language-diff" style="width: max-content; margin: 0 auto; font-size: 120%">     uuid:
-      type: string
-      label: 'UUID'
+      type: uuid
</code></pre>
              <figcaption><em>Any</em> string 😳
            </figure>
          </section>
          <section data-background-gradient="radial-gradient(#283b95, #17b2c3)">
            <h2>🤔</h2>
          </section>
          <section data-background-gradient="radial-gradient(orange, red)">
            <h2>🤯</h2>
          </section>
        </section>
        <section>
          <section id="types-of-types" style="font-size:90%;">
            <table style="margin: 0;">
              <tr class="fragment"><th style="border-bottom: none; text-align: center">Data</th><th colspan="3" style="text-align: center">Types</th></tr>
              <tr class="fragment"><th></th><th>Config</th><th>Storage</th><th>Perceived</th><th></th></tr>
              <tr class="fragment"><td><small><code>'f962b8c7-
4c74-4100-
b6de-08e6a65ff43d'</code></small></td><td><code>uuid</code></td><td><code>string</code></td><td>UUID</td><td>👍</td></tr>
              <tr class="fragment" ><div style="position: absolute; transform:rotate(0.75turn); font-size: 40%; top:16em; left: -6em;"><p><code>media.settings</code></p></div><td><small><code>'https://oembed.com/
                providers.json'</code></small></td><td>uri</td><td><code>string</code></td><td>URL</td><td>👍</td></tr>
              <tr class="fragment"><td><small><code>''</code></small></td><td>uri</td><td><code>string</code></td><td style="animation: loading 2.5s linear infinite;">🤪</td><td>🙈</td></tr>
              <tr class="fragment"><th></th><th><em>intent</em></th><th><em>shape</em></th><th><em>semantics</th><th></th></tr>
            </table>
            <aside class="notes">
              The theoretical implications of choosing a particular type that we really want for practical reasons (assuming some input contains some kind of data) is unfortunately completely missing in practice, making the usefuless theoretical 🙃
            </aside>
          </section>
          <section>
            <p>Validators needed! 🙏</p>
          </section>
          <section>
            <p>It gets worse.</p>
          </section>
          <section id="types-of-types-worse" style="font-size:90%;">
            <table style="margin: 0;">
              <tr class=""><th style="border-bottom: none; text-align: center">Data</th><th colspan="3" style="text-align: center">Types</th></tr>
              <tr class=""><th></th><th>Config</th><th>Storage</th><th>Perceived</th><th></th></tr>
              <tr class=""><td><small><code>'f962b8c7-
4c74-4100-
b6de-08e6a65ff43d'</code></small></td><td><code>uuid</code></td><td><code>string</code></td><td>UUID</td><td>👍</td></tr>
              <tr class=""><div style="position: absolute; transform:rotate(0.75turn); font-size: 40%; top:16em; left: -6em;"><p><code>media.settings</code></p></div><td><small><code>'https://oembed.com/
                providers.json'</code></small></td><td>uri</td><td><code>string</code></td><td>URL</td><td>👍</td></tr>
              <tr class="fra"><td><small><code>''</code></small></td><td>uri</td><td><code>string</code></td><td>🤪</td><td>🙈</td></tr>
              <tr class="fragment"><td><small><code>'first-uuid'</code></small></td><td><code>uuid</code></td><td><code>string</code></td><td>🤪</td><td class="fragment grow" style="animation: growingshrinking 2.5s linear infinite; animation-direction: alternate-reverse">😱</td></tr>
            </table>
          </section>
          <section>
            <p>Validators are not executed today.</p>
          </section>
          <section id="types-this-aint-fine" data-background-video="img/thisisfine.mp4"></section>
          <section data-background-gradient="radial-gradient(yellow, orange)" style="text-shadow: -1px 1px 2px #23430C">
            <h3>The new blobbiness</h3>
            <p>🫠</p>
            <ul>
              <li>Many validators missing.
              <li>Validators not executed.
            </ul>
          </section>
        </section>
      </section>
      <section>
        <section id="status-core">
          <h3>Drupal Core</h3>
        </section>
        <section id="status-core--ugly">
          <h3>Core: ugly</h3>
          <p class="fragment custom blur"><span class="bad">&gt;95%</span> of config types not validatable</p>
          <small><p class="fragment custom blur"><a href="https://www.drupal.org/project/drupal/issues/3324984">#3324984</a> adds a test that reports this %.</p></small>
        </section>
        <section id="status-core--bad">
          <h3>Core: bad</h3>
          <p>Every test checks schema …</p>
          <p class="fragment custom blur">… but <span class="bad">does not validate!</span></p>
          <small><p class="fragment custom blur"><a href="https://www.drupal.org/project/drupal/issues/3361534">#3361534</a> calls <code>::validate()</code> when <code>::$strictConfigSchema = TRUE</code></p></small>
        </section>
        <section id="status-core--good-one">
          <h3>Good</h3>
          <p>More config validatable!</p>
          <ul>
            <div class="fragment custom blur">
              <li><code>type: config_dependencies</code>
              <li><code>block.block.*:plugin</code>
            </div>
            <div class="fragment custom blur">
              <li><a href="https://www.drupal.org/project/drupal/issues/2920678">#2920678</a> 👉 <code>type: machine_name</code>
              <li><a href="https://www.drupal.org/project/drupal/issues/3341682">#3341682</a> 👉 <code>type: label</code>
            </div>
          </ul>
        </section>
        <section id="status-core--good-two">
          <h3>Good</h3>
          <p>More validation constraints to reuse!</p>
          <ul>
            <li class="fragment custom blur"><code>ValidKeys: &lt;infer&gt;</code>
            <li class="fragment custom blur"><code>PluginExists: plugin.manager.block</code>
            <li class="fragment custom blur"><code>ExtensionName: []</code>
            <li class="fragment custom blur"><code>ExtensionExists: module</code>
            <li class="fragment custom blur"><code>ConfigExists: []</code>
            <li class="fragment custom blur"><code>RequiredConfigDependencies: ['filter_format']</code>
          </ul>
        </section>
        <section id="status-core--interested">
          <h3>Interested?</h3>
          <p>Issue tags:</p>
          <ul>
            <li><a href="https://www.drupal.org/project/issues/search?issue_tags=Configuration%20schema"><q>Configuration schema</q></a>
            <li><a href="https://www.drupal.org/project/issues/search?issue_tags=validation"><q>validation</q></a>
          </ul>
        </section>
      </section>
      <section>
        <section>
          <section id="config_inspector">
            <h3>Configuration Inspector</h3>
            <a href="https://www.drupal.org/project/config_inspector">d.o/project/config_inspector</a>
          </section>
        </section>
      </section>
      <section>
        <section>
          <section id="status-contrib">
            <h3>Drupal Contrib</h3>
          </section>
          <section>
            <p>You <em>can</em> start using it today!
          </section>
          <section id="contrib">
            <p>start using in contrib today</p>
            <p>CDN module — since 2020</p>
            <p>base class in contrib module, or copy/paste</p>
          </section>
        </section>
        <section>
          <section id="tools">
            <p>https://www.drupal.org/project/config_inspector</p>
          </section>
        </section>
        <section>
          <section id="future">
            <p>challenges: partially validatable
            <p>functionality opportunities: JS admin UI, JSON:API, recipes</p>
            <p>operational opportunities: reliability (CI!), module maintainability</p>
          </section>
        </section>
        <section>
          <section id="HELP">
            <p>help needed to complete this!</p>
            <p>which config changes have caused outages for YOU?</p>
          </section>
        </section>

      </div>

    </div>

    <script src="reveal.js/dist/reveal.js"></script>
    <script src="reveal.js/plugin/zoom/zoom.js"></script>
    <script src="reveal.js/plugin/notes/notes.js"></script>
    <script src="reveal.js/plugin/search/search.js"></script>
    <script src="reveal.js/plugin/markdown/markdown.js"></script>
    <script src="reveal.js/plugin/highlight/highlight.js"></script>
    <script>

      // Also available as an ES module, see:
      // https://revealjs.com/initialization/
      Reveal.initialize({
        controls: true,
        progress: true,
        center: true,
        hash: true,

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [ RevealZoom, RevealNotes, RevealSearch, RevealMarkdown, RevealHighlight ]
      });

    </script>

  </body>
</html>